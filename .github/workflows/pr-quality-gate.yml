name: üõë Quality Gate (PR -> Main)

on:
  pull_request:
    branches:
      - main  # üü¢ Only runs when merging to Production

jobs:
  ephemeral-test:
    name: üß™ Ephemeral Stack & Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read # Required to pull the Backend image

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Login to GHCR (To pull the Backend image)
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 2. Spin up the Full Stack (Frontend + Backend + DB)
      - name: üèóÔ∏è Spin up Ephemeral Stack
        run: |
          # We export the repo owner for the docker-compose variable
          export GITHUB_REPOSITORY_OWNER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')
          
          echo "üöÄ Starting stack with Backend Image: ghcr.io/$GITHUB_REPOSITORY_OWNER/weaveit-server-staging:latest"
          
          docker compose -f docker-compose.yml up -d --build
          
          echo "‚è≥ Waiting 30s for services to stabilize..."
          sleep 30

      # 3. Debugging (If it fails, we need to know why)
      - name: üîç Debug Container Status
        if: always()
        run: docker compose -f docker-compose.yml ps -a

      # 4. Integration Test
      - name: üîó Verify Connections
        run: |
          echo "Testing Frontend..."
          curl --fail --retry 5 --retry-delay 2 http://localhost:3000 || exit 1
          
          echo "Testing Backend Reachability..."
          curl --fail --retry 5 --retry-delay 2 http://localhost:3001/api/health || echo "‚ö†Ô∏è Backend health check skipped or not found"

          echo "‚úÖ Stack is healthy!"

      # 5. DAST Scan (OWASP ZAP)
      # This attacks your running Frontend to find vulnerabilities
      - name: üïµÔ∏è Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv' # Optional: You can ignore specific false positives here later
          cmd_options: '-a' # '-a' includes alpha rules (optional)
          allow_issue_writing: false # Set to true if you want ZAP to create GitHub Issues for bugs
        continue-on-error: true # üü¢ Recommendation: Don't block merge on ZAP alerts initially, just log them.

      # 6. Teardown
      - name: üßπ Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down