name: Frontend CI - Build, Test & Security

on:
  push:
    branches: ["dev", "master", "speed"]
      # Add 'feat/**' here if you want to test feature branches (but you might want to limit the Push step)

env:
  # üü¢ CHANGE: Naming it 'weaveit-ui' to match your project
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/weaveit-ui-staging

jobs:
  # =========================
  # 1Ô∏è‚É£ Semgrep Security Scan (SAST)
  # =========================
  semgrep:
    name: üõ°Ô∏è Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          # üü¢ CHANGE: Use remote rulesets instead of local config
          # p/default = Generic security best practices
          # p/react   = React-specific security rules
          # p/typescript = TypeScript-specific security rules
          config: >-
            .semgrep.yml 
            p/default
            p/react
            p/typescript
            p/secrets
        continue-on-error: true 

  # =========================
  # 2Ô∏è‚É£ Build, Test, and Push
  # =========================
  build-and-push:
    name: Build Docker Image & Push
    runs-on: ubuntu-latest
    needs: semgrep
    permissions:
      contents: read
      packages: write # Required to push to GHCR

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # A. Build the Static Assets (Node.js)
      # --------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        # üü¢ ADAPTATION: Using the fix we found in Phase 1
        run: |
          npm config set fetch-retries 5
          npm install --legacy-peer-deps

      - name: Lint Code
        run: npm run lint
        continue-on-error: true

      # --------------------------------------------------------
      # B. Build Docker Image
      # --------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lowercase Repo Owner
        run: |
          echo "REPO_OWNER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build Docker Image
        run: |
          FULL_IMAGE_NAME="ghcr.io/${REPO_OWNER}/weaveit-ui-staging:latest"
          
          # üü¢ Note: Next.js reads ENV vars at build time or via process.env.
          # If you have build-time secrets, pass them as --build-arg here.
          docker build -t $FULL_IMAGE_NAME .
          
          echo "FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV

      # --------------------------------------------------------
      # C. Smoke Test (Ephemeral)
      # --------------------------------------------------------
      - name: üß™ Test Image Startup (Smoke Test)
        run: |
          echo "Starting container to verify entrypoint..."
          
          # üü¢ ADAPTATION: Next.js runs on port 3000
          docker run -d --name test-frontend -p 3000:3000 $FULL_IMAGE_NAME
          
          echo "‚è≥ Waiting 10s for Next.js to boot..."
          sleep 10
          
          # 1. Check if it crashed
          if [ "$(docker inspect -f '{{.State.Running}}' test-frontend)" = "false" ]; then
            echo "‚ùå Container crashed!"
            docker logs test-frontend
            exit 1
          fi

          # 2. Check logs for success message
          # Next.js usually says "Ready in Xms" or "Listening on port 3000"
          docker logs test-frontend

          # 3. HTTP Check
          # We use curl to see if the server responds
          echo "Testing localhost:3000..."
          curl --fail http://localhost:3000 || (echo "‚ùå Health check failed" && exit 1)
          
          echo "‚úÖ Smoke test passed!"
          docker rm -f test-frontend

      # --------------------------------------------------------
      # D. Push to Registry
      # --------------------------------------------------------
      - name: Push Docker Image
        # üü¢ SAFETY: Only push if we are on the master branch
        if: github.ref == 'refs/heads/master'
        run: |
          docker push $FULL_IMAGE_NAME
          echo "‚úÖ Pushed $FULL_IMAGE_NAME"